<!-- PIN LOCK OVERLAY -->
<div id="pinOverlay" style="
  position:fixed;
  inset:0;
  background:#0b0f14;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#141826;
    padding:24px;
    border-radius:14px;
    width:100%;
    max-width:320px;
    text-align:center;
    color:#e6e8ee;
  ">
    <h2 style="margin-bottom:8px">SOLUS Kilidi</h2>
    <p style="font-size:14px;color:#9aa4b2;margin-bottom:14px">
      6 haneli PIN gir
    </p>
    <input
      id="pinInput"
      type="password"
      inputmode="numeric"
      maxlength="6"
      placeholder="••••••"
      style="
        width:100%;
        padding:12px;
        font-size:20px;
        text-align:center;
        border-radius:10px;
        border:1px solid #232a3a;
        background:#0f1220;
        color:#fff;
        letter-spacing:6px;
      "
    />
    <button
      onclick="checkPIN()"
      style="
        margin-top:14px;
        width:100%;
        padding:12px;
        border-radius:10px;
        background:#1a2236;
        color:#fff;
        border:none;
        font-size:16px;
      "
    >Kilidi Aç</button>

    <p id="pinMsg" style="color:#ff6b6b;font-size:13px;margin-top:10px"></p>
  </div>
</div>

<script>
  const PIN_KEY = "SOLUS_PIN";

  function checkPIN() {
    const input = document.getElementById("pinInput").value;
    const saved = localStorage.getItem(PIN_KEY);

    if (!saved) {
      if (input.length !== 6) {
        msg("PIN 6 haneli olmalı");
        return;
      }
      localStorage.setItem(PIN_KEY, input);
      unlock();
      return;
    }

    if (input === saved) {
      unlock();
    } else {
      msg("Yanlış PIN");
    }
  }

  function unlock() {
    document.getElementById("pinOverlay").style.display = "none";
  }

  function msg(t) {
    document.getElementById("pinMsg").innerText = t;
  }
</script>
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOLUS</title>

  <meta name="theme-color" content="#0d0f14" />
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root { --bg:#0d0f14; --panel:#141826; --line:#232a3a; --txt:#eaeaea; --muted:#9aa4b2; }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--txt); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; }
    .wrap{ max-width:780px; margin:0 auto; padding:18px; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; }
    h1{ margin:0 0 6px; letter-spacing:6px; text-align:center; }
    .sub{ text-align:center; color:var(--muted); font-size:12px; margin-bottom:14px; }
    input,button,textarea{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--line);
      background:#0f1220; color:var(--txt); font-size:16px;
    }
    button{ background:#1a2236; cursor:pointer; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:150px; }
    .msgs{ height:58vh; overflow:auto; padding:10px; background:#0b0e16; border:1px solid var(--line); border-radius:12px; }
    .msg{ margin:10px 0; line-height:1.35; white-space:pre-wrap; }
    .me{ color:#8ab4ff; }
    .ai{ color:#b7ffd8; }
    .meta{ color:var(--muted); font-size:12px; }
    .hidden{ display:none; }
    .pill{ display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card" id="loginCard">
    <h1>S O L U S</h1>
    <div class="sub">Sadece senin. Hafıza telefonda.</div>
    <input id="pw" type="password" placeholder="Giriş anahtarı" autocomplete="current-password">
    <div class="row" style="margin-top:10px">
      <button id="btnEnter">GİRİŞ</button>
      <button id="btnSetPw" title="İlk kurulum / şifre değiştir">ŞİFRE BELİRLE</button>
    </div>
    <div class="meta" style="margin-top:10px">
      Not: Şifre ve sohbet geçmişi yalnızca bu telefonda saklanır.
    </div>
  </div>

  <div class="card hidden" id="chatCard">
    <div class="row" style="align-items:center; margin-bottom:10px">
      <div class="pill" id="statusPill">Offline • Local</div>
      <button id="btnExport">Geçmişi indir</button>
      <button id="btnImport">Geçmişi yükle</button>
      <button id="btnClear">Geçmişi sil</button>
      <button id="btnLock">Kilitle</button>
    </div>

    <div class="msgs" id="msgs"></div>

    <div class="row" style="margin-top:10px">
      <textarea id="input" rows="2" placeholder="SOLUS seni dinliyor… (Enter = gönder)"></textarea>
      <button id="btnSend">Gönder</button>
    </div>
    <div class="meta" style="margin-top:8px">
      İpucu: “Beni hatırla: …” yazarsan SOLUS profil notuna ekler.
    </div>
  </div>
</div>

<script>
  const K_PW = "solus_pw_hash_v1";
  const K_CHAT = "solus_chat_v1";
  const K_PROFILE = "solus_profile_v1";

  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
  }

  const loginCard = document.getElementById("loginCard");
  const chatCard = document.getElementById("chatCard");
  const pw = document.getElementById("pw");
  const msgsEl = document.getElementById("msgs");
  const input = document.getElementById("input");

  function loadChat(){ return JSON.parse(localStorage.getItem(K_CHAT) || "[]"); }
  function saveChat(arr){ localStorage.setItem(K_CHAT, JSON.stringify(arr)); }
  function loadProfile(){ return JSON.parse(localStorage.getItem(K_PROFILE) || '{"notes":[]}'); }
  function saveProfile(p){ localStorage.setItem(K_PROFILE, JSON.stringify(p)); }

  function render(){
    const chat = loadChat();
    msgsEl.innerHTML = "";
    for (const m of chat){
      const div = document.createElement("div");
      div.className = "msg " + (m.role === "user" ? "me" : "ai");
      div.textContent = (m.role === "user" ? "Sen: " : "SOLUS: ") + m.content;
      msgsEl.appendChild(div);
    }
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  function add(role, content){
    const chat = loadChat();
    chat.push({ role, content, t: Date.now() });
    saveChat(chat);
    render();
  }

  function solusReply(userText){
    const profile = loadProfile();
    const chat = loadChat();
    const lastUser = [...chat].reverse().find(x=>x.role==="user" && x.content !== userText)?.content;

    const m = userText.match(/^\s*beni hatırla\s*:\s*(.+)$/i);
    if (m){
      profile.notes.push(m[1].trim());
      saveProfile(profile);
      return "Tamam. Bunu hafızama ekledim:\n- " + m[1].trim();
    }

    if (/ne hatırlıyorsun|hafıza/i.test(userText)){
      if (!profile.notes.length) return "Şu an profil notlarım boş. “Beni hatırla: …” ile doldurabilirsin.";
      return "Profil notlarım:\n" + profile.notes.map(n=>"• "+n).join("\n");
    }

    let ref = lastUser ? `\n\nAz önce şunu söylemiştin: “${lastUser}”` : "";
    if (profile.notes.length){
      ref += `\n\nProfil notu: “${profile.notes[profile.notes.length-1]}”`;
    }

    return "Anladım. Offline moddayım; konuşmalarımız bu telefonda kalıyor." + ref;
  }

  async function ensurePasswordSet(){
    const existing = localStorage.getItem(K_PW);
    if (existing) return true;
    const p1 = prompt("Yeni SOLUS şifresi belirle:");
    if (!p1) return false;
    const p2 = prompt("Şifreyi tekrar yaz:");
    if (p1 !== p2) { alert("Şifreler uyuşmadı."); return false; }
    localStorage.setItem(K_PW, await sha256(p1));
    alert("Şifre kaydedildi.");
    return true;
  }

  async function enter(){
    const stored = localStorage.getItem(K_PW);
    if (!stored){
      const ok = await ensurePasswordSet();
      if (!ok) return;
    }
    const typed = pw.value || "";
    const h = await sha256(typed);
    if (h !== localStorage.getItem(K_PW)){
      alert("Şifre yanlış.");
      return;
    }
    pw.value = "";
    loginCard.classList.add("hidden");
    chatCard.classList.remove("hidden");
    render();
    if (loadChat().length === 0){
      add("assistant", "Hoş geldin. Ben SOLUS. Konuşmalarımız sadece bu telefonda kalır.");
    }
  }

  document.getElementById("btnEnter").onclick = enter;
  document.getElementById("btnSetPw").onclick = ensurePasswordSet;

  document.getElementById("btnSend").onclick = ()=>{
    const text = input.value.trim();
    if (!text) return;
    input.value = "";
    add("user", text);
    const reply = solusReply(text);
    add("assistant", reply);
  };

  input.addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      document.getElementById("btnSend").click();
    }
  });

  document.getElementById("btnClear").onclick = ()=>{
    if (!confirm("Tüm sohbet geçmişi silinsin mi?")) return;
    localStorage.removeItem(K_CHAT);
    render();
    add("assistant", "Geçmiş silindi.");
  };

  document.getElementById("btnLock").onclick = ()=>{
    chatCard.classList.add("hidden");
    loginCard.classList.remove("hidden");
  };

  document.getElementById("btnExport").onclick = ()=>{
    const blob = new Blob([JSON.stringify({chat:loadChat(), profile:loadProfile()}, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "solus-backup.json";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  document.getElementById("btnImport").onclick = async ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async ()=>{
      const file = inp.files[0];
      if (!file) return;
      const txt = await file.text();
      const obj = JSON.parse(txt);
      if (obj.chat) saveChat(obj.chat);
      if (obj.profile) saveProfile(obj.profile);
      render();
      add("assistant", "Yedek yüklendi.");
    };
    inp.click();
  };

  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("sw.js").catch(()=>{});
  }
</script>
</body>
</html>
